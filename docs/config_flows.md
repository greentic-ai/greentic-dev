# Config Flows and `flow add-step`

This CLI lets you graft a componentâ€™s config flow (stored in the component manifest) into an existing pack flow YAML.

## TL;DR
- Config flows live in `component.manifest.json` under `dev_flows` (generated by `greentic-component flow update`).
- Pack flows live in `flows/<flow-id>.ygtc` inside your pack workspace.
- `greentic-dev flow add-step <pack-flow-id> --coordinate <component>` runs the config flow from the manifest and splices the returned node into `flows/<pack-flow-id>.ygtc`.
- If the config flow is missing, rerun `greentic-component flow update`.

## Quickstart
```bash
# Use a local manifest (defaults to ./component.manifest.json) and edit flows/onboarding.ygtc
greentic-dev flow add-step onboarding --coordinate ./component-bundle

# Force guided vs default config flow (manifest.dev_flows.custom/default)
greentic-dev flow add-step onboarding \
  --coordinate store://meeza/component-qa-process@^0.3 \
  --mode custom

# Patch routing after an existing node
greentic-dev flow add-step onboarding \
  --coordinate ./component-bundle \
  --after start

# Work on a different manifest path
greentic-dev flow add-step onboarding \
  --manifest ../component-adaptive-card/component.manifest.json \
  --coordinate ./component-bundle
```

## How it works
1) The CLI locates `flows/<pack-flow-id>.ygtc` in the current workspace.
2) It reads `component.manifest.json` (default `./component.manifest.json`) and selects `dev_flows[flow_id]` (or `.custom` via `--mode custom`).
3) It runs that config flow graph and expects JSON with:
   ```json
   { "node_id": "qa_step", "node": { "qa": { "component": "..." }, "routing": [...] } }
   ```
4) It inserts `node` under `nodes[node_id]` in the target pack flow YAML.
5) If `--after foo` is supplied (or selected interactively), it appends a routing edge from `foo` to `node_id`.

## Authoring config flows (component side)
- Run `greentic-component flow update` to (re)generate `dev_flows` inside the manifest.
- Ensure the flow ends with a node that yields `{ node_id, node }` (either via `payload:` or a `template` string that renders to that JSON).
- Keep routing inside `node` as you want it wired; the CLI only appends an edge from `--after` when provided.

## Current limits
- Config flows must exist in `manifest.dev_flows`; otherwise the command errors with guidance to run `greentic-component flow update`.
- Formatting of the updated pack flow is best-effort YAML.
