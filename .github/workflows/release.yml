name: Release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to crates.io (true/false)"
        default: "true"
        required: true
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    name: Package/Publish (serialized)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Configure cargo directories
        run: |
          echo "CARGO_HOME=${{ runner.temp }}/cargo-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR=${{ runner.temp }}/target-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tomlq
        run: cargo install tomlq --locked

      - name: Verify build (locked)
        run: |
          cargo fetch --locked
          cargo build --workspace --locked --all-features
          cargo test --workspace --locked --all-features -- --quiet

      - name: Cargo package (dry-run)
        run: cargo package --locked --allow-dirty --no-verify || true

      - name: Publish (optional)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -eo pipefail
          if output=$(cargo publish --locked 2>&1); then
            printf "%s\n" "$output"
          else
            printf "%s\n" "$output"
            if printf "%s\n" "$output" | grep -qi "already exists on crates.io index"; then
              echo "crate version already published; skipping publish step."
            else
              exit 1
            fi
          fi

  dist:
    name: Build release binaries (${{ matrix.target }})
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-13
            target: x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Configure cargo directories
        run: |
          echo "CARGO_HOME=${{ runner.temp }}/cargo-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR=${{ runner.temp }}/target-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build and package ${{ matrix.target }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata --format-version 1 --no-deps | python - <<'PY'
import json, sys
metadata = json.load(sys.stdin)
for pkg in metadata["packages"]:
    if pkg.get("name") == "greentic-dev":
        print(pkg["version"])
        sys.exit(0)
sys.exit("failed to find greentic-dev version")
PY
          )

          TARGET="${{ matrix.target }}"
          ARTIFACT_DIR="dist"
          STAGING="$ARTIFACT_DIR/greentic-dev-v${VERSION}-${TARGET}"

          cargo fetch --locked --target "$TARGET"
          cargo build --workspace --locked --all-features --release --target "$TARGET"

          BIN_PATH="$CARGO_TARGET_DIR/$TARGET/release/greentic-dev"
          if [[ "$TARGET" == *windows* ]]; then
            BIN_PATH+=".exe"
          fi

          mkdir -p "$STAGING"
          cp "$BIN_PATH" "$STAGING/"
          cp README.md LICENSE-MIT LICENSE-APACHE "$STAGING/"

          tar czf "$STAGING.tgz" -C "$STAGING" .

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: greentic-dev-${{ matrix.target }}
          path: dist/greentic-dev-v*-${{ matrix.target }}.tgz
          if-no-files-found: error

  release:
    name: GitHub Release
    needs: dist
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List release assets
        run: ls -R dist

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          target_commitish: ${{ github.sha }}
          files: dist/**/*.tgz
          generate_release_notes: true
