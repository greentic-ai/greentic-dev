name: Release

on:
  # Branch pushes to master and manual dispatch:
  # - run CI (build/test)
  # - publish to crates.io
  # - build release artifacts
  # - create/update a GitHub Release
  push:
    branches:
      - master
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    name: CI (build/test) + Publish
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      CARGO_HOME: ${{ github.workspace }}/.cargo-${{ github.job }}-${{ github.run_id }}
      CARGO_TARGET_DIR: ${{ github.workspace }}/.target-${{ github.job }}-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL /usr/share/dotnet || true
          df -h

      - uses: dtolnay/rust-toolchain@stable

      - name: Add cargo bin to PATH
        run: echo "${CARGO_HOME}/bin" >> "$GITHUB_PATH"

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Verify build (locked)
        run: |
          cargo install cargo-binstall --locked || true
          cargo binstall -y --locked greentic-flow greentic-component greentic-pack greentic-runner
          cargo fetch --locked
          cargo build --workspace --locked --all-features
          cargo test --workspace --locked --all-features -- --quiet

      - name: Cargo package (dry-run)
        run: cargo package --locked --allow-dirty --no-verify || true

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -eo pipefail
          set +e
          publish_output=$(cargo publish --locked 2>&1)
          publish_status=$?
          set -e

          printf "%s\n" "$publish_output"

          if [ "$publish_status" -eq 0 ]; then
            exit 0
          fi

          if printf "%s\n" "$publish_output" | grep -qi "already exists on crates.io index"; then
            echo "crate version already published; skipping publish step."
            echo "crate version already on crates.io; no new publish performed."
            exit 0
          fi

          exit "$publish_status"

  dist:
    name: Build release binaries (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: publish
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      CARGO_HOME: ${{ github.workspace }}/.cargo-${{ github.job }}-${{ github.run_id }}
      CARGO_TARGET_DIR: ${{ github.workspace }}/.target-${{ github.job }}-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL /usr/share/dotnet || true
          df -h

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build and package ${{ matrix.target }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata --format-version 1 --no-deps | python -c 'import json,sys; data=json.load(sys.stdin); print(next(p["version"] for p in data["packages"] if p.get("name")=="greentic-dev"))')

          TARGET="${{ matrix.target }}"
          ARTIFACT_DIR="dist"
          STAGING="$ARTIFACT_DIR/greentic-dev-v${VERSION}-${TARGET}"

          cargo fetch --locked --target "$TARGET"
          cargo build --workspace --locked --all-features --release --target "$TARGET"

          BIN_EXT=""
          if [[ "$TARGET" == *windows* ]]; then
            BIN_EXT=".exe"
          fi

          mkdir -p "$STAGING"
          cp "$CARGO_TARGET_DIR/$TARGET/release/greentic-dev$BIN_EXT" "$STAGING/"
          cp "$CARGO_TARGET_DIR/$TARGET/release/greentic-component$BIN_EXT" "$STAGING/"

          # Optional companion tools included only in release bundles (installed from crates.io).
          install_crate_tool() {
            local crate="$1"
            local bin="$2"
            local version_req="${3:-^0.4}"
            local dest="${4:-$bin}"
            echo "[bundle] installing ${crate} ${version_req} for ${TARGET} from crates.io"
            tmpdir="$(mktemp -d)"
            cargo install "${crate}" --locked --version "${version_req}" --target "${TARGET}" --root "${tmpdir}" --bin "${bin}"
            local bin_path="${tmpdir}/bin/${bin}${BIN_EXT}"
            if [[ ! -f "${bin_path}" ]]; then
              echo "[bundle] expected ${bin_path} after cargo install; contents:"
              ls -la "${tmpdir}/bin"
              exit 1
            fi
            cp "${bin_path}" "${STAGING}/${dest}${BIN_EXT}"
          }

          install_crate_tool "greentic-gui" "greentic-gui" "^0.4"
          install_crate_tool "greentic-flow" "greentic-flow" "^0.4"
          install_crate_tool "greentic-pack" "greentic-pack" "^0.4"
          install_crate_tool "greentic-runner" "greentic-runner" "^0.4"
          install_crate_tool "greentic-secrets-cli" "greentic-secrets-cli" "^0.4" "greentic-secrets"

          cp README.md LICENSE-MIT LICENSE-APACHE "$STAGING/"

          tar czf "$STAGING.tgz" -C "$STAGING" .

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: greentic-dev-${{ matrix.target }}
          path: dist/greentic-dev-v*-${{ matrix.target }}.tgz
          if-no-files-found: error

  release:
    name: GitHub Release
    needs: [publish, dist]
    if: needs.publish.result == 'success' && needs.dist.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Compute crate version
        id: version
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | python -c 'import json,sys; data=json.load(sys.stdin); print(next(p["version"] for p in data["packages"] if p.get("name")=="greentic-dev"))')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List release assets
        run: ls -R dist

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: greentic-dev v${{ steps.version.outputs.version }}
          files: dist/**/*.tgz
          generate_release_notes: true
