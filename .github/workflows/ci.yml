name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (stable)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      RUSTFLAGS: "-D warnings"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Use repo rust-toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Configure cargo directories
        run: |
          echo "CARGO_HOME=${{ runner.temp }}/cargo-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR=${{ runner.temp }}/target-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"

      - name: Install tomlq
        run: cargo install tomlq --locked

      - name: Prime caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: ci-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.job }}
          restore-keys: |
            ci-${{ runner.os }}-${{ github.job }}-

      - name: Install minimal deps
        run: |
          rustup --version
          cargo --version
          cargo fetch --locked

      - name: Lint (clippy + fmt)
        run: |
          cargo fmt --all -- --check
          cargo clippy --all --all-features --locked -- -D warnings

      - name: Build (all)
        run: cargo build --workspace --all-features --locked

      - name: Tests
        run: cargo test --workspace --all-features --locked -- --nocapture

      - name: Pack smoke
        if: hashFiles('**/Cargo.toml') != ''
        run: cargo build --workspace --locked --release
