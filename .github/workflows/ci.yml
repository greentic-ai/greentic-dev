name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (stable)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      RUSTFLAGS: "-D warnings"
      CARGO_INCREMENTAL: "0"
      CARGO_PROFILE_TEST_DEBUG: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/share/dotnet || true
          docker system prune -af || true

      - name: Use repo rust-toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Configure cargo directories
        run: |
          echo "CARGO_HOME=${{ runner.temp }}/cargo-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR=${{ runner.temp }}/target-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR_RELEASE=${{ runner.temp }}/target-release-${{ github.job }}-${{ github.run_id }}" >> "$GITHUB_ENV"

      - name: Install tomlq
        run: cargo install tomlq --locked

      - name: Prime caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
          key: ci-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.job }}
          restore-keys: |
            ci-${{ runner.os }}-${{ github.job }}-

      - name: Install minimal deps
        run: |
          rustup --version
          cargo --version
          cargo fetch --locked

      - name: Install required tool binaries
        run: |
          cargo install cargo-binstall --locked || true
          cargo binstall -y --locked greentic-flow greentic-component packc greentic-pack greentic-runner ygtc-lint

      - name: Lint (clippy + fmt)
        run: |
          cargo fmt --all -- --check
          cargo clippy --all --all-features --locked -- -D warnings

      - name: Build (all)
        run: cargo build --workspace --all-features --locked

      - name: Tests
        run: cargo test --workspace --all-features --locked -- --nocapture

      - name: Free space before release build
        run: rm -rf "${CARGO_TARGET_DIR}" || true

      - name: Pack smoke
        if: hashFiles('**/Cargo.toml') != ''
        env:
          CARGO_TARGET_DIR: ${{ env.CARGO_TARGET_DIR_RELEASE }}
        run: cargo build --workspace --locked --release
